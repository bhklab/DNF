---
title: "Evaluate Imputation Performance"
output:
  html_notebook: default
  html_document: default
---

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath(".."))
```

## Using Old Perturbation Signatures

### Performance on CTRPv2

Get all necessary imports and functions
```{r, message=FALSE, warning=FALSE}
rm(list=ls())

set.seed(9833)

library(ROCR)
library(reshape2)
library(caret)
library(SNFtool)
library(org.Hs.eg.db)
source("RCode/flexible_layers/sensitivityDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexibleCustomSig.R")
source("RCode/flexible_layers/structureDataFlexible.R")
source("RCode/flexible_layers/imagingDataFlexible.R")

source("RCode/flexible_layers/constImagingLayerFlexible.R")
source("RCode/flexible_layers/constSensitivityLayerFlexible.R")
source("RCode/flexible_layers/constPerturbationLayerFlexible.R")
source("RCode/flexible_layers/constStructureLayerFlexible.R")

source("RCode/cindexComp2.R")
source("RCode/flexible_layers/compConcordIndxFlexible.R")
source("RCode/flexible_layers/generateDrugPairsFlexible.R")
source("RCode/flexible_layers/drugTargetBenchFlexible.R")
source("RCode/flexible_layers/compDrugTargetBenchmarkFlexible.R")
source("RCode/flexible_layers/stackedLayerAnalysisHelpers.R")
source("RCode/flexible_layers/printCIndices.R")
source("RCode/flexible_layers/printPVals.R")
source("RCode/flexible_layers/generateROCPlotFlexible.R")
source("RCode/predPerf.R")
source("RCode/value_inference_models/modifying_snf/snfModifiedHelpers.R")

badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"


```

Load LINCS metadata file. Used it contains the smiles string for the drugs in the perturbation layer. These are then used to construct the structure layer.
```{r}
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)
```

Load in senstivity, imaging data as well as perturbation signatures

```{r}
pert.file.name <- "Data/L1000_compound_signatures.RData"
sensitivity.file.name <- "Data/combined_sensitivity//combined_sens_iname_replaced.RData"
imaging.file.name <- "Data/imaging_processed/imaging_subsetted_normalized_pca.RData"

sens.data <- SensitivityDataFlexible(sensitivity.file.name)  ## 645 X 239
pert.data <- PerturbationDataFlexible(pert.file.name, lincs.meta)  ## 978 X 23
imaging.data <- ImagingDataFlexible(badchars)

imaging.data <- imaging.data[, colnames(imaging.data) %in% colnames(sens.data)]

```

Subset the lincs metadata file to only the drugs appearing in the sensitivity layer

```{r}
sens.names <- rownames(sens.data)

lincs.meta.subset <- lincs.meta[match(sens.names, lincs.meta$pert_iname),]
lincs.meta.subset <- lincs.meta.subset[!is.na(lincs.meta.subset$X),]
```

Now we create the structure fingerprints based on the subsetted lincs metadata

```{r}
strc.data <- StructureDataFlexible(lincs.meta.subset)  ## a vector  --> 239 elemnts
```


Now we can choose the layers to be used in the integration and see the drugs that are common between them

```{r}
layers <- list(sens.names = sort(colnames(sens.data)), pert.names=colnames(pert.data),
               strc.names = names(strc.data))
common.drugs <- Reduce(intersect, Filter(Negate(is.null),layers))
print(length(common.drugs))
```

At this point we have all the data necessary to create the various similarity matrices. Keep in mind that in the case of the senstivity layer, the data loaded in is already a similarity matrix, so there is nothing to do there. Note that we are leaving out the perturbation layer since that is the one that we are evaluating the effect of imputation on.

```{r}
strc.cor <- fingerprint::fp.sim.matrix(strc.data, method = "tanimoto")
colnames(strc.cor) <- names(strc.data)
rownames(strc.cor) <- names(strc.data)

imaging.cor <- ConstImagingLayerFlexible(imaging.data)

sens.cor <- sens.data[common.drugs, common.drugs]
```

To impute drugs that are actually relevant to the benchmark, we need to obtain the drugs that would actually be used in the benchmark.

```{r}
benchmark.drugs <- DrugTargetBenchFlexible(common.drugs, gmt_file_name="temp", use.ctrpv2=TRUE,
                        use.clue=FALSE, use.chembl=FALSE, use.dbank=FALSE, use.dtc=FALSE)
benchmark.drugs <- colnames(benchmark.drugs)
```

Now let's create some subsetted versions of the pert data correlation matrices. These

```{r}
set.seed(981)
imputation.sizes <- c(0, 10, 25, 50, 100, length(benchmark.drugs))

subsetted.pert.cor <- list()
subsetted.sens.cor <- list()
subsetted.strc.cor <- list()

for (i in imputation.sizes) {
    drugs.to.remove <- sample(1:length(benchmark.drugs), i)
    drugs.to.remove <- benchmark.drugs[drugs.to.remove]
    
    temp.pert <- pert.data[, common.drugs]
    temp.pert <- temp.pert[, !(colnames(temp.pert) %in% drugs.to.remove)]
    subsetted.pert.cor[[as.character(i)]] <- cor(temp.pert, method="pearson", use="pairwise.complete.obs")
    
    temp.sens <- sens.data[common.drugs, common.drugs]
    temp.sens <- temp.sens[!(rownames(temp.sens) %in% drugs.to.remove), !(colnames(temp.sens) %in% drugs.to.remove)]
    subsetted.sens.cor[[as.character(i)]] <- temp.sens
    
    temp.strc <- strc.data[common.drugs]
    temp.strc <- temp.strc[!(names(temp.strc) %in% drugs.to.remove)]
    temp.names <- names(temp.strc)
    temp.strc <- fingerprint::fp.sim.matrix(temp.strc, method = "tanimoto")
    colnames(temp.strc) <- temp.names
    rownames(temp.strc) <- temp.names
    subsetted.strc.cor[[as.character(i)]] <- temp.strc
}
```


We need to determine the union of all drugs between the various layers. These will then become the row and column names for the various augmented matrices.

```{r}
all.drugs <- common.drugs
```

#### Perturbation Imputation Effect

Now we loop over the various subsetted perturbation data versions and evaluate the performance of imputing the drugs that are intentionally missing.

```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[[as.character(i)]]
    sens.cor <- subsetted.sens.cor[["0"]]
    strc.cor <- subsetted.strc.cor[["0"]]
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=FALSE, use.chembl=FALSE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```

#### Senstivity Imputation Effect

Now we loop over the various subsetted sensitivity data versions and evaluate the performance of imputing the drugs that are intentionally missing.
```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[["0"]]
    sens.cor <- subsetted.sens.cor[[as.character(i)]]
    strc.cor <- subsetted.strc.cor[["0"]]
    
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=FALSE, use.chembl=FALSE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```

#### Structure Imputation Effect

Now we loop over the various subsetted structure data versions and evaluate the performance of imputing the drugs that are intentionally missing.
```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[["0"]]
    sens.cor <- subsetted.sens.cor[["0"]]
    strc.cor <- subsetted.strc.cor[[as.character(i)]]
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=FALSE, use.chembl=FALSE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```

### Performance on CTRPv2, CHEMBL, and clue.io combined

Now we take a look at the performance on an aggregated drug target dataset consisting of ctrp, chembl, and clue. Hopefully now there will be a negative impact on perturbation if we keep imputing more drugs.

We repeat the process of getting the vector of drugs that will actually be in the benchmark. Again, we are removing drugs only from this set, since only these drugs have an effect on benchmark performance.

```{r}
benchmark.drugs <- DrugTargetBenchFlexible(common.drugs, gmt_file_name="temp", use.ctrpv2=TRUE,
                        use.clue=TRUE, use.chembl=TRUE, use.dbank=FALSE, use.dtc=FALSE)
benchmark.drugs <- colnames(benchmark.drugs)
```

We again create subsetted versions of the pert layer, each with progressively less drugs in them

```{r}
set.seed(981)
imputation.sizes <- c(0, 25, 50, 75, 100, 125, 150, 175, 200,length(benchmark.drugs))

subsetted.pert.cor <- list()
subsetted.sens.cor <- list()
subsetted.strc.cor <- list()

for (i in imputation.sizes) {
    drugs.to.remove <- sample(1:length(benchmark.drugs), i)
    drugs.to.remove <- benchmark.drugs[drugs.to.remove]
    
    temp.pert <- pert.data[, common.drugs]
    temp.pert <- temp.pert[, !(colnames(temp.pert) %in% drugs.to.remove)]
    subsetted.pert.cor[[as.character(i)]] <- cor(temp.pert, method="pearson", use="pairwise.complete.obs")
    
    temp.sens <- sens.data[common.drugs, common.drugs]
    temp.sens <- temp.sens[!(rownames(temp.sens) %in% drugs.to.remove), !(colnames(temp.sens) %in% drugs.to.remove)]
    subsetted.sens.cor[[as.character(i)]] <- temp.sens
    
    temp.strc <- strc.data[common.drugs]
    temp.strc <- temp.strc[!(names(temp.strc) %in% drugs.to.remove)]
    temp.names <- names(temp.strc)
    temp.strc <- fingerprint::fp.sim.matrix(temp.strc, method = "tanimoto")
    colnames(temp.strc) <- temp.names
    rownames(temp.strc) <- temp.names
    subsetted.strc.cor[[as.character(i)]] <- temp.strc
}
```

#### Perturbation Imputation Effect

Now we loop over the various subsetted perturbation data versions and evaluate the performance of imputing the drugs that are intentionally missing.

```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[[as.character(i)]]
    sens.cor <- subsetted.sens.cor[["0"]]
    strc.cor <- subsetted.strc.cor[["0"]]
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```

#### Senstivity Imputation Effect

Now we loop over the various subsetted sensitivity data versions and evaluate the performance of imputing the drugs that are intentionally missing.
```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[["0"]]
    sens.cor <- subsetted.sens.cor[[as.character(i)]]
    strc.cor <- subsetted.strc.cor[["0"]]
    
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```

#### Structure Imputation Effect

Now we loop over the various subsetted structure data versions and evaluate the performance of imputing the drugs that are intentionally missing.
```{r, fig.width=5, fig.height=5}
for (i in imputation.sizes) {
    pert.cor <- subsetted.pert.cor[["0"]]
    sens.cor <- subsetted.sens.cor[["0"]]
    strc.cor <- subsetted.strc.cor[[as.character(i)]]
    
    correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)
    
    augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
    augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, correlation.matrices)
    affinity.matrices <- CreateAffinityMatrices(augmented.matrices)
    affinity.matrices <- ReplaceAffinityMatrixValuesFast(affinity.matrices, correlation.matrices, all.drugs)
    
    integrated <- SNFtool::SNF(affinity.matrices)
    rownames(integrated) <- all.drugs
    colnames(integrated) <- all.drugs
    
    paste("-----Evaluating Performance on ", i, "imputed drugs-----", sep=" ")
    
    CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                    strc.aff.mat=affinity.matrices$strc, 
                                    sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                    integration=integrated, luminex.aff.mat=NULL,
                                    imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                    use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                    use.dbank=FALSE, use.dtc=FALSE)

}
```