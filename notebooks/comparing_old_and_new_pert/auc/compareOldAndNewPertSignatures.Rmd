---
title: "Compare Old And New Pert Signatures"
output:
  html_document: default
  html_notebook: default
---
In this notebook, we show the performance of the vanilla model with 3 layers (where sensitivity datsets have been combined into a single matrix to increase overlap). This is essentially the new benchmark to beat in terms of auc.

In order not to lose our sanity with the relative file paths that rmd chooses to employ, let's set the root directory of this project

```{r setup}
knitr::opts_knit$set(root.dir = normalizePath('../../../'))
getwd()
```


We start by importing the necessary functions

```{r, message=FALSE, warning=FALSE}
rm(list=ls())

source("RCode/flexible_layers/structureDataFlexible.R")
source("RCode/flexible_layers/sensitivityDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexibleCustomSig.R")
source("RCode/flexible_layers/luminexDataFlexible.R")
source("RCode/flexible_layers/imagingDataFlexible.R")

source("RCode/flexible_layers/constSensitivityLayerFlexible.R")
source("RCode/flexible_layers/constStructureLayerFlexible.R")
source("RCode/flexible_layers/constLuminexLayerFlexible.R")
source("RCode/flexible_layers/constImagingLayerFlexible.R")
source("RCode/flexible_layers/constPerturbationLayerFlexible.R")

source("RCode/flexible_layers/integrateLayersFlexible.R")
source("RCode/flexible_layers/generateDrugPairsFlexible.R")
source("RCode/flexible_layers/drugTargetBenchFlexible.R")
source("RCode/flexible_layers/compConcordIndxFlexible.R")
source("RCode/flexible_layers/printCIndices.R")
source("RCode/flexible_layers/printPVals.R")
source("RCode/flexible_layers/generateROCPlotFlexible.R")
source("RCode/flexible_layers/atcBenchFlexible.R")
source("RCode/flexible_layers/compDrugTargetBenchmarkFlexible.R")
source("RCode/flexible_layers/computeATCBenchmarkFlexible.R")
source("RCode/flexible_layers/stackedLayerAnalysisHelpers.R")
source("RCode/flexible_layers/communityGenFlexible.R")

source("RCode/cindexComp2.R")
source("RCode/predPerf.R")

library(PharmacoGx)
library(apcluster)
library(rcdk)
library(fingerprint)
library(annotate)
library(org.Hs.eg.db)
library(SNFtool)
library(ROCR)
library(survcomp)
library(reshape2)
library(proxy)
library(PRROC)
library(apcluster)

# Load lincs metadata and clean the pert_inames in it
badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)

pert.file.name <- "Data/L1000_compound_signatures.RData"
sensitivity.file.name <- "Data/combined_sensitivity//combined_sens_iname_replaced.RData"
source("RCode/flexible_layers/stackedLayerAnalysis.R")
#  Drugs that are common between new signatures and sens data. This is needed to compare apples with apples
# in terms having benchmarks that include the same drugs in them.
common.drugs <- readRDS("common_drugs.RData") 
```


We begin with evaluating the performance of our model on the ctrpv2 dataset. Only 138 drugs since some were missing in the new pert signatures. HEre is performance using old signatures, but subsetted to only the drugs that are also in the new signatures so we compare apples with apples.

```{r, fig.width=5, fig.height=5}
pert.file.name <- "Data/L1000_compound_signatures.RData"
res <- EvaluateModelROC(use.sensitivity=TRUE, use.perturbation=TRUE, use.structure=TRUE,
            use.imaging=FALSE, use.luminex=FALSE, 
             sensitivity.file.name=sensitivity.file.name, pert.file.name=pert.file.name, 
            lincs.meta=lincs.meta,
             atc.benchmark.name="chembl-new", compute.atc=FALSE, use.ctrpv2=TRUE, use.clue=FALSE,
             use.chembl=FALSE, use.dbank=FALSE, use.dtc=FALSE, create.communities=FALSE, base.dir="Output/auc_p_flex", pert.new=FALSE, common.drugs=common.drugs)
```

Here is the performance on those same drugs but now using the new signatures.

```{r, fig.width=5, fig.height=5}
pert.file.name <- "Data/pert_sigs_6_hour/pert_features_full.RData"
res <- EvaluateModelROC(use.sensitivity=TRUE, use.perturbation=TRUE, use.structure=TRUE,
            use.imaging=FALSE, use.luminex=FALSE, 
             sensitivity.file.name=sensitivity.file.name, pert.file.name=pert.file.name, 
            lincs.meta=lincs.meta,
             atc.benchmark.name="chembl-new", compute.atc=FALSE, use.ctrpv2=TRUE, use.clue=FALSE,
             use.chembl=FALSE, use.dbank=FALSE, use.dtc=FALSE, create.communities=FALSE, base.dir="Output/auc_p_flex", pert.new=TRUE, common.drugs=common.drugs)
```

Now we move on to using a merged drug target dataset of both clue, ctrp, and chembl. The hope is that the increase in performance is more apparent since the sensitivity layer won't be so strong.

First, the old signatures.

```{r, fig.width=5, fig.height=5}
pert.file.name <- "Data/L1000_compound_signatures.RData"
res <- EvaluateModelROC(use.sensitivity=TRUE, use.perturbation=TRUE, use.structure=TRUE,
            use.imaging=FALSE, use.luminex=FALSE, 
             sensitivity.file.name=sensitivity.file.name, pert.file.name=pert.file.name, 
            lincs.meta=lincs.meta,
             atc.benchmark.name="chembl-new", compute.atc=FALSE, use.ctrpv2=TRUE, use.clue=TRUE,
             use.chembl=TRUE, use.dbank=FALSE, use.dtc=FALSE, create.communities=FALSE, base.dir="Output/auc_p_flex", pert.new=FALSE, common.drugs=common.drugs)
```

Now, the new signatures

```{r, fig.width=5, fig.height=5}
pert.file.name <- "Data/pert_sigs_6_hour/pert_features_full.RData"
res <- EvaluateModelROC(use.sensitivity=TRUE, use.perturbation=TRUE, use.structure=TRUE,
            use.imaging=FALSE, use.luminex=FALSE, 
             sensitivity.file.name=sensitivity.file.name, pert.file.name=pert.file.name, 
            lincs.meta=lincs.meta,
             atc.benchmark.name="chembl-new", compute.atc=FALSE, use.ctrpv2=TRUE, use.clue=TRUE,
             use.chembl=TRUE, use.dbank=FALSE, use.dtc=FALSE, create.communities=FALSE, base.dir="Output/auc_p_flex", pert.new=TRUE, common.drugs=common.drugs)
```




