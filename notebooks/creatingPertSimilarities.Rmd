---
title: "Creating Pert Similarities Vector Based Correlation"
output:
  html_document: default
  html_notebook: default
---

```{r setup}
knitr::opts_knit$set(root.dir=normalizePath(".."))
```


We begin by loading in the signatures file which contains a list of signatures.

```{r}
rm(list=ls())
signatures <- readRDS("Data/signatures.RData")
```

Now we need to concatenate these signatures into a matrix for each drug

```{r}

concatenated.signatures <- list()

for (cell.line in names(signatures)) {
    cell.line.signatures <- signatures[[cell.line]][, , "estimate"]
    
    for (drug in colnames(cell.line.signatures)) {
        if (is.null(concatenated.signatures[[drug]])) {
            concatenated.signatures[[drug]] <- cell.line.signatures[, drug]
            names(concatenated.signatures[[drug]]) <- paste(cell.line, names(concatenated.signatures[[drug]]), sep=":::")
        } else {
            temp <- cell.line.signatures[, drug]
            names(temp) <- paste(cell.line, names(temp), sep=":::")
            concatenated.signatures[[drug]] <- c(concatenated.signatures[[drug]], temp)
        }
    }
}
```

So `concatenated.signatures` is a list of vectors where each vector is a bunch of pert sigs concatenated together


```{r}
signature.sizes <- lapply(concatenated.signatures, length)
max.length <- Reduce(max, signature.sizes)
placeholder <- matrix(NA, nrow=max.length, ncol=length(concatenated.signatures))
colnames(placeholder) <- names(concatenated.signatures)

all.cell.gene.combos <- c()

for (cell.line in names(signatures)) { 
    gene.names <- rownames(signatures[[cell.line]][, , "estimate"])
    
    all.cell.gene.combos <- c(all.cell.gene.combos, paste(cell.line, gene.names, sep=":::"))
}

rownames(placeholder) <- all.cell.gene.combos

for (drug in names(concatenated.signatures)) {
    sig <- concatenated.signatures[[drug]]
    
    placeholder[names(sig), drug] <- sig
}
```

```{r}
badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)

relevant.indices <- match(colnames(placeholder), lincs.meta$pert_id)
drug.names <- lincs.meta$pert_iname[relevant.indices]

colnames(placeholder) <- drug.names

placeholder <- placeholder[, order(colnames(placeholder))]

saveRDS(placeholder, "Data/pert_sigs_6_hour/pert_features_full.RData")
```


Lastly, we compute the actual correlations

```{r}
drug.correlations <- cor(placeholder, method="pearson", use="pairwise.complete.obs")
```

Finally, we replace the pert ids with pert inames

```{r}
badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)

relevant.indices <- match(colnames(drug.correlations), lincs.meta$pert_id)
drug.names <- lincs.meta$pert_iname[relevant.indices]

colnames(drug.correlations) <- drug.names
rownames(drug.correlations) <- drug.names

drug.correlations <- drug.correlations[order(rownames(drug.correlations)), order(colnames(drug.correlations))]
```

Last but not least, we save the resulting matrix to file

```{r}
saveRDS(drug.correlations, "Data/pert_sigs_6_hour/pert_correlations_full.RData")
```

