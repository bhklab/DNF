---
title: "Quantitative Analysis of Targets"
output: html_notebook
---

## Description

This notebook takes a look a various statistics regarding drug target datasets.

## Experiments

### Load Data

```{r setup}
knitr::opts_knit$set(root.dir=normalizePath("../../"))
```

```{r, message=FALSE, warning=FALSE}
rm(list=ls())

set.seed(9833)

library(reactome.db)
library(extrafont)
loadfonts(device="win")
library(ggplot2)
library(ROCR)
library(reshape2)
library(org.Hs.eg.db)

source("RCode/flexible_layers/sensitivityDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexibleCustomSig.R")
source("RCode/flexible_layers/structureDataFlexible.R")

source("RCode/flexible_layers/constSensitivityLayerFlexible.R")
source("RCode/flexible_layers/constPerturbationLayerFlexible.R")
source("RCode/flexible_layers/constStructureLayerFlexible.R")

source("RCode/flexible_layers/drugTargetBenchFlexible.R")
source("RCode/knn/drugTargetsKNN.R")

badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"
```

```{r}
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)
```


```{r}
sensitivity.file.name <- "Data/combined_sensitivity//combined_sens_iname_replaced.RData"

sens.data <- SensitivityDataFlexible(sensitivity.file.name)  ## 645 X 239
```

```{r}
common.drugs <- intersect(rownames(sens.data), lincs.meta$pert_iname)
```

### Get Drug Targets

```{r}
data.bench <- DrugTargetsKNN(common.drugs, gmt_file_name="temp", use.ctrpv2=TRUE,
                        use.clue=TRUE, use.chembl=TRUE, use.dbank=TRUE, use.dtc=FALSE)
data.bench[] <- lapply(data.bench, as.character)
```

### Targets With Most Drugs

Let's look at the top 10 targets in terms of most drugs.

```{r}
top.10.targets <- sapply(unique(data.bench$TARGET_NAME), function(t, df) {
    num <- df[df$TARGET_NAME == t, ]
    num <- nrow(num)
    return(num)
}, df=data.bench)

top.10.targets <- head(sort(top.10.targets, decreasing=T), 10)

df.data <- data.frame(target=names(top.10.targets), count=top.10.targets)


p <- ggplot(data=df.data, aes(x=reorder(target, -count), y=count))
p <- p + geom_bar(stat="identity")
p
```
Now let's see the names of these drugs. Perhaps there is an obvious pattern

```{r}
drugs.in.top.10.targets <- data.bench[data.bench$TARGET_NAME %in% names(top.10.targets), ]
View(drugs.in.top.10.targets)
```

### Drugs with the most targets

```{r, fig.height=6, fig.width=9}
top.10.drugs <- sapply(unique(data.bench$MOLECULE_NAME), function(drug, df) {
    num <- df[df$MOLECULE_NAME == drug, ]
    num <- nrow(num)
    return(num)
}, df=data.bench)

top.10.drugs <- head(sort(top.10.drugs, decreasing=T), 10)

df.data <- data.bench[data.bench$MOLECULE_NAME %in% names(top.10.drugs), ]
df.data$count <- NA

for (drug in df.data$MOLECULE_NAME) {
    df.data[df.data$MOLECULE_NAME == drug, "count"] <- top.10.drugs[drug]
}

df.data$MOLECULE_NAME <- factor(df.data$MOLECULE_NAME)

p <- ggplot()

for (drug in unique(df.data$MOLECULE_NAME)) {
    df.sub <- df.data[df.data$MOLECULE_NAME == drug, ]
    
    p <- p + geom_bar(data=df.sub, aes(x=MOLECULE_NAME), stat="count")
    p <- p + geom_text(data=df.sub, aes(x=MOLECULE_NAME, label=paste(TARGET_NAME, collapse="\n"), y=count / 2), stat="identity", color="white", family="Helvetica")
}

p <- p
p

```

### Pathway Level Grouping

What if we group these very similar targets into pathways so that we don't have what are essentially duplicates? 

```{r}
temp.targets <- data.bench$TARGET_NAME[data.bench$MOLECULE_NAME == "TAMOXIFEN"]

temp.entrez <- unlist(mget(temp.targets, org.Hs.egSYMBOL2EG))

temp.pathways <- AnnotationDbi::select(reactome.db,
                      keys=temp.entrez,
                      keytype="ENTREZID",
                      columns=c("ENTREZID","REACTOMEID","PATHNAME"))

pathways <- list()
for (entrez in unique(temp.pathways$ENTREZID)) {
    temp <- temp.pathways[temp.pathways$ENTREZID == entrez, "REACTOMEID"]
    pathways[[entrez]] <- temp
}

new.targets <- list()

for (entrez in names(pathways)) {
    temp.1 <- pathways[[entrez]]
    
    for (j in setdiff(names(pathways), entrez)) {
        temp.2 <- pathways[[j]]
        
        intersection <- sort(intersect(temp.1, temp.2))
        
        if (length(intersection) > 0) {
            new.targets[[entrez]] <- intersection[[1]]
        }
    }
}

new.targets <- unlist(new.targets)
new.targets <- unique(new.targets)
```




