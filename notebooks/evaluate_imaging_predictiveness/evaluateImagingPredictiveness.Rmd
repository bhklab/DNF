---
title: "Investigate Predictiveness of Imaging Layer"
output: html_notebook
---

Now that we have our imputation method, we can see if the imaging layer helps AUC, without looking at a benchmark that is reduced in terms of drugs.

```{r setup}
knitr::opts_knit$set(root.dir=normalizePath("../../"))
```

## Load Data

Get all necessary imports and functions
```{r, message=FALSE, warning=FALSE}
rm(list=ls())

set.seed(9833)

library(ROCR)
library(reshape2)
library(caret)
library(SNFtool)
library(org.Hs.eg.db)
source("RCode/flexible_layers/sensitivityDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexibleCustomSig.R")
source("RCode/flexible_layers/structureDataFlexible.R")
source("RCode/flexible_layers/imagingDataFlexible.R")

source("RCode/flexible_layers/constImagingLayerFlexible.R")
source("RCode/flexible_layers/constSensitivityLayerFlexible.R")
source("RCode/flexible_layers/constPerturbationLayerFlexible.R")
source("RCode/flexible_layers/constStructureLayerFlexible.R")

source("RCode/cindexComp2.R")
source("RCode/flexible_layers/compConcordIndxFlexible.R")
source("RCode/flexible_layers/generateDrugPairsFlexible.R")
source("RCode/flexible_layers/drugTargetBenchFlexible.R")
source("RCode/flexible_layers/compDrugTargetBenchmarkFlexible.R")
source("RCode/flexible_layers/stackedLayerAnalysisHelpers.R")
source("RCode/flexible_layers/printCIndices.R")
source("RCode/flexible_layers/printPVals.R")
source("RCode/flexible_layers/generateROCPlotFlexible.R")
source("RCode/predPerf.R")
source("RCode/value_inference_models/modifying_snf/snfModifiedHelpers.R")

source("RCode/goldenberg_imputation/medianSimilarity.R")

badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"


```

Load LINCS metadata file. Used it contains the smiles string for the drugs in the perturbation layer. These are then used to construct the structure layer.
```{r}
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)
```

Load in senstivity, imaging data as well as perturbation signatures

```{r}
pert.file.name <- "Data/L1000_compound_signatures.RData"
sensitivity.file.name <- "Data/combined_sensitivity//combined_sens_iname_replaced.RData"
imaging.file.name <- "Data/imaging_processed/imaging_full_scaled.rds"

sens.data <- SensitivityDataFlexible(sensitivity.file.name)  ## 645 X 239
pert.data <- PerturbationDataFlexible(pert.file.name, lincs.meta)  ## 978 X 23
imaging.data <- ImagingDataFlexible(badchars, imaging.file.name)

imaging.data <- imaging.data[, colnames(imaging.data) %in% colnames(sens.data)]

```

Subset the lincs metadata file to only the drugs appearing in the sensitivity layer

```{r}
sens.names <- rownames(sens.data)

lincs.meta.subset <- lincs.meta[match(sens.names, lincs.meta$pert_iname),]
lincs.meta.subset <- lincs.meta.subset[!is.na(lincs.meta.subset$X),]
```

Now we create the structure fingerprints based on the subsetted lincs metadata

```{r}
strc.data <- StructureDataFlexible(lincs.meta.subset)  ## a vector  --> 239 elemnts
```

## Find Common Drugs

Now to find the drugs that are common between all layers

Now we can choose the layers to be used in the integration and see the drugs that are common between them

```{r}
layers <- list(sens.names = sort(colnames(sens.data)), pert.names=colnames(pert.data),
               strc.names = names(strc.data))
common.drugs <- Reduce(intersect, Filter(Negate(is.null),layers))
print(length(common.drugs))
```

## Create Similarities

At this point we have all the data necessary to create the various similarity matrices. Keep in mind that in the case of the senstivity layer, the data loaded in is already a similarity matrix, so there is nothing to do there. Note that we are leaving out the perturbation layer since that is the one that we are evaluating the effect of imputation on.

```{r}
strc.cor <- fingerprint::fp.sim.matrix(strc.data, method = "tanimoto")
colnames(strc.cor) <- names(strc.data)
rownames(strc.cor) <- names(strc.data)

imaging.cor <- ConstImagingLayerFlexible(imaging.data)
pert.cor <- cor(pert.data[, common.drugs], method="pearson", use="pairwise.complete.obs")

sens.cor <- sens.data[common.drugs, common.drugs]
```

## Integrate Network

```{r}
all.drugs <- common.drugs

correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor, imaging=imaging.cor)

affinity.matrices <- CreateAffinityMatrices(correlation.matrices)
augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, affinity.matrices)
affinity.matrices <- ReplaceAffinityMatrixValuesFast(augmented.matrices, correlation.matrices, 
                                                     all.drugs)
affinity.matrices <- medianSimilarity(affinity.matrices)

integrated <- SNFtool::SNF(affinity.matrices)
rownames(integrated) <- all.drugs
colnames(integrated) <- all.drugs
```

## Evaluate Performance With Imaging

### On CTRPv2 Drug Target Dataset

```{r, fig.width=5, fig.height=5}
CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                strc.aff.mat=affinity.matrices$strc, 
                                sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                integration=integrated, luminex.aff.mat=NULL,
                                imaging.aff.mat=affinity.matrices$imaging, target.roc.file.name="blessed_roc.pdf",
                                use.ctrpv2=TRUE, use.clue=FALSE, use.chembl=FALSE, 
                                use.dbank=FALSE, use.dtc=FALSE)
```

### On Combined CTRPv2, CLUE, CHEMBL Drug Target Dataset

```{r, fig.width=5, fig.height=5}
CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                strc.aff.mat=affinity.matrices$strc, 
                                sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                integration=integrated, luminex.aff.mat=NULL,
                                imaging.aff.mat=affinity.matrices$imaging, target.roc.file.name="blessed_roc.pdf",
                                use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                use.dbank=FALSE, use.dtc=FALSE)
```

## Evaluate Performance Without Imaging

First, we have to recreate the network with the imaging layer removed

```{r}
all.drugs <- common.drugs

correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)

affinity.matrices <- CreateAffinityMatrices(correlation.matrices)
augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, affinity.matrices)
affinity.matrices <- ReplaceAffinityMatrixValuesFast(augmented.matrices, correlation.matrices, 
                                                     all.drugs)
affinity.matrices <- medianSimilarity(affinity.matrices)

integrated <- SNFtool::SNF(affinity.matrices)
rownames(integrated) <- all.drugs
colnames(integrated) <- all.drugs
```

### On CTRPv2 Drug Target Dataset

```{r, fig.width=5, fig.height=5}
CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                strc.aff.mat=affinity.matrices$strc, 
                                sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                integration=integrated, luminex.aff.mat=NULL,
                                imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                use.ctrpv2=TRUE, use.clue=FALSE, use.chembl=FALSE, 
                                use.dbank=FALSE, use.dtc=FALSE)
```

### On Combined CTRPv2, CLUE, CHEMBL Drug Target Dataset

```{r, fig.width=5, fig.height=5}
CompDrugTargetBenchmarkFlexible(common.drugs=common.drugs, gmt.file.name="temp",
                                strc.aff.mat=affinity.matrices$strc, 
                                sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                integration=integrated, luminex.aff.mat=NULL,
                                imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                use.dbank=FALSE, use.dtc=FALSE)
```

## Conclusion

As can be seen in the above plots, there is no significant improvement in AUC when we include the imaging layer. This suggests that the added complexity of having it as another layer is not worth the slight performance boost gain, which very well could just be noise