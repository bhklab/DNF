---
title: "Largest Possible Network"
output: html_notebook
---

## Description

Our standard network contains 365 drugs in it, with 8 of those drugs having to be imputed in the perturbation layer since we're using the new perturbation signatures. The aim of this notebook is to create the largest network possible by using all information from the sensitivity layer, and not subsetting to just the drugs that are in common with structure and perturbation.

```{r setup}
knitr::opts_knit$set(root.dir=normalizePath("../../"))
```

## Full Network on Combined Benchmark

Get all necessary imports and functions
```{r, message=FALSE, warning=FALSE}
rm(list=ls())

set.seed(9833)

library(ROCR)
library(reshape2)
library(caret)
library(SNFtool)
library(org.Hs.eg.db)
library(doParallel)
library(foreach)

source("RCode/flexible_layers/sensitivityDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexible.R")
source("RCode/flexible_layers/perturbationDataFlexibleCustomSig.R")
source("RCode/flexible_layers/structureDataFlexible.R")
source("RCode/flexible_layers/imagingDataFlexible.R")

source("RCode/flexible_layers/constImagingLayerFlexible.R")
source("RCode/flexible_layers/constSensitivityLayerFlexible.R")
source("RCode/flexible_layers/constPerturbationLayerFlexible.R")
source("RCode/flexible_layers/constStructureLayerFlexible.R")

source("RCode/cindexComp2.R")
source("RCode/flexible_layers/compConcordIndxFlexible.R")
source("RCode/flexible_layers/generateDrugPairsFlexible.R")
source("RCode/flexible_layers/drugTargetBenchFlexible.R")
source("RCode/flexible_layers/compDrugTargetBenchmarkFlexible.R")
source("RCode/flexible_layers/stackedLayerAnalysisHelpers.R")
source("RCode/flexible_layers/printCIndices.R")
source("RCode/flexible_layers/printPVals.R")
source("RCode/flexible_layers/generateROCPlotFlexible.R")
source("RCode/predPerf.R")
source("RCode/value_inference_models/modifying_snf/snfModifiedHelpers.R")

source("RCode/goldenberg_imputation/medianSimilarity.R")

source("RCode/foreach_utils/foreachUtils.R")
source("RCode/knn/drugTargetsKNN.R")
source("RCode/knn/knnCV.R")
source("RCode/knn/knnHelpers.R")

badchars <- "[\xb5]|[\n]|[,]|[;]|[:]|[-]|[+]|[*]|[%]|[$]|[#]|[{]|[}]|[[]|[]]|[|]|[\\^]|[/]|[\\]|[.]|[_]|[ ]"


```

Load LINCS metadata file. Used it contains the smiles string for the drugs in the perturbation layer. These are then used to construct the structure layer.
```{r}
lincs.meta <- read.csv("Data/LINCS.csv", stringsAsFactors = FALSE)
lincs.meta$pert_iname <- toupper(lincs.meta$pert_iname)
lincs.meta$pert_iname <- gsub(badchars, "", lincs.meta$pert_iname)
```

Load in senstivity, imaging data as well as perturbation signatures

```{r}
pert.file.name <- "Data/pert_sigs_6_hour/pert_features_full.RData"
sensitivity.file.name <- "Data/combined_sensitivity//combined_sens_iname_replaced.RData"

sens.data <- SensitivityDataFlexible(sensitivity.file.name)  ## 645 X 239
pert.data <- PerturbationDataFlexibleCustomSig(pert.file.name)  ## 978 X 23
```

Subset the lincs metadata file to only the drugs appearing in the sensitivity layer

```{r}
sens.names <- rownames(sens.data)

lincs.meta.subset <- lincs.meta[match(sens.names, lincs.meta$pert_iname),]
lincs.meta.subset <- lincs.meta.subset[!is.na(lincs.meta.subset$X),]
```

Now we create the structure fingerprints based on the subsetted lincs metadata

```{r}
strc.data <- StructureDataFlexible(lincs.meta.subset)  ## a vector  --> 239 elemnts
```

## Find Common Drugs

Now to find the drugs that are common between all layers

Now we can choose the layers to be used in the integration and see the drugs that are common between them. Leave out pert names from the intersection since we know that the pert layer is missing 8 drugs compared to the strc layer, so we'll use our imputation method to get a full integrated network of 365 drugs instead of 357 drugs.

```{r}
layers <- list(sens.names = sort(colnames(sens.data)),
               strc.names = names(strc.data))
common.drugs <- Reduce(intersect, Filter(Negate(is.null),layers))
print(length(common.drugs))
```

## Create Similarities

At this point we have all the data necessary to create the various similarity matrices. Keep in mind that in the case of the senstivity layer, the data loaded in is already a similarity matrix, so there is nothing to do there. Note that we are leaving out the perturbation layer since that is the one that we are evaluating the effect of imputation on.

```{r}
strc.cor <- fingerprint::fp.sim.matrix(strc.data, method = "tanimoto")
colnames(strc.cor) <- names(strc.data)
rownames(strc.cor) <- names(strc.data)

strc.cor <- strc.cor[common.drugs, common.drugs]

pert.cor <- cor(pert.data[, intersect(common.drugs, colnames(pert.data))], method="pearson", use="pairwise.complete.obs")

pert.cor <- medianSimilarity(list(pert.cor))[[1]]

sens.cor <- sens.data
```

## Integrate Network

```{r}
all.drugs <- sort(rownames(sens.data))

correlation.matrices <- list(sens=sens.cor, pert=pert.cor, strc=strc.cor)

affinity.matrices <- CreateAffinityMatrices(correlation.matrices)
augmented.matrices <- CreateAugmentedMatrixSkeletons(names(correlation.matrices), all.drugs)
augmented.matrices <- ReplaceAugmentedExistingValues(augmented.matrices, affinity.matrices)
affinity.matrices <- ReplaceAffinityMatrixValuesFast(augmented.matrices, correlation.matrices, 
                                                     all.drugs)
affinity.matrices <- medianSimilarity(affinity.matrices)

integrated <- SNFtool::SNF(affinity.matrices)
rownames(integrated) <- all.drugs
colnames(integrated) <- all.drugs
```


### Evaluate AUC Performance on Combined Drug Target Dataset

```{r, fig.width=5, fig.height=5}
CompDrugTargetBenchmarkFlexible(common.drugs=all.drugs, gmt.file.name="temp",
                                strc.aff.mat=affinity.matrices$strc, 
                                sens.aff.mat=affinity.matrices$sens, pert.aff.mat=affinity.matrices$pert,
                                integration=integrated, luminex.aff.mat=NULL,
                                imaging.aff.mat=NULL, target.roc.file.name="blessed_roc.pdf",
                                use.ctrpv2=TRUE, use.clue=TRUE, use.chembl=TRUE, 
                                use.dbank=TRUE, use.dtc=FALSE)
```

### Evaluate KNN Performance on Combined Drug Target Dataset

```{r}
data.bench <- DrugTargetsKNN(all.drugs, use.ctrpv2=TRUE, 
                             use.clue=TRUE,
                             use.chembl=TRUE,
                             use.dbank=TRUE,
                             use.dtc=FALSE)

data.bench[] <- lapply(data.bench, as.character)
```


```{r}
loo.networks <- CreateLeaveOneOutNetworks(integrated, correlation.matrices, all.drugs, data.bench)
accuracies <- numeric(length(loo.networks))
names(accuracies) <- names(loo.networks)
k <- 5

for (drug in names(loo.networks)) {
    loo.net <- loo.networks[[drug]]
    
    accuracies[drug] <- GetKNNAccuracySingle(k, loo.net, data.bench, drug, top=5)
}

accuracy <- sum(accuracies) / length(accuracies)
```

